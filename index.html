const $ = (id) => document.getElementById(id);

// æ£€æµ‹æ˜¯å¦åœ¨ GitHub Pages è¿è¡Œ
const isGitHubPages = window.location.hostname.includes("github.io");

async function loadConfig() {
  if (isGitHubPages) {
    console.log("é™æ€å±•ç¤ºæ¨¡å¼ï¼šè·³è¿‡ API é…ç½®åŠ è½½");
    return;
  }
  try {
    const res = await fetch("/api/config");
    const cfg = await res.json();
    if (cfg.target_url) $("target_url").value = cfg.target_url;
    if (cfg.item_limit) $("item_limit").value = cfg.item_limit;
  } catch (e) {
    console.error("é…ç½®åŠ è½½å¤±è´¥:", e);
  }
}

async function refreshData() {
  // æ ¸å¿ƒä¿®æ”¹ï¼šçº¿ä¸Šè¯»å–é™æ€ jsonï¼Œæœ¬åœ°è¯»å– api
  const dataPath = isGitHubPages ? "./data.json" : "/api/data";
  try {
    const res = await fetch(dataPath);
    if (!res.ok) throw new Error("æ— æ³•è·å–æ•°æ®æ–‡ä»¶");
    const data = await res.json();

    $("last_time").textContent = data.beijing_time || "-";

    // æ¸²æŸ“ AI æ€»ç»“
    const summaryEl = $("ai_summary");
    summaryEl.innerHTML = "";
    const summary = (data.ai_summary || "").trim();
    if (summary) {
      const lines = summary.split(/\r?\n/).filter(ln => ln.trim().startsWith("-"));
      const ul = document.createElement("ul");
      ul.className = "space-y-2";
      lines.forEach(ln => {
        const li = document.createElement("li");
        li.className = "rounded-xl border border-slate-800 bg-slate-950/40 p-3 text-sm leading-relaxed";
        li.textContent = ln.replace(/^-+\s*/, "");
        ul.appendChild(li);
      });
      summaryEl.appendChild(ul);
    } else {
      summaryEl.innerHTML = '<div class="text-slate-500">æš‚æ— æ€»ç»“</div>';
    }

    // æ¸²æŸ“åˆ—è¡¨ (çœç•¥éƒ¨åˆ†é‡å¤æ¸²æŸ“é€»è¾‘ï¼Œä¿æŒä¸ä½ ä¹‹å‰ä¸€è‡´)
    renderItems(data.items); 
  } catch (e) {
    console.error("åˆ·æ–°æ•°æ®å¤±è´¥:", e);
    $("status").textContent = "æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ä»“åº“ä¸­æ˜¯å¦å­˜åœ¨ data.json";
  }
}

// ä¿®æ”¹è¿è¡ŒæŒ‰é’®é€»è¾‘
$("save_run").onclick = async () => {
  if (isGitHubPages) {
    alert("ğŸ”’ çº¿ä¸Šç‰ˆä»…ä¾›æŸ¥çœ‹æ•°æ®ã€‚\nè‹¥éœ€ä¿®æ”¹å‚æ•°å¹¶è¿è¡Œï¼Œè¯·å‰å¾€ GitHub ä»“åº“çš„ Actions é¡µé¢æ‰‹åŠ¨ç‚¹å‡» 'Run workflow'ã€‚");
    return;
  }
  // ... æœ¬åœ°è¿è¡Œé€»è¾‘ä¿æŒä¸å˜ ...
};
